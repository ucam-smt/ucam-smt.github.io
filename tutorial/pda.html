<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.9.1"/>
<title>Cambridge SMT System: RTNs and PDAs</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Cambridge SMT System
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.9.1 -->
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('pda.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">RTNs and PDAs </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>As already discussed with respect to <a class="el" href="basictrans.html#lpruning">Inadmissible Pruning</a>, HiFST generates an initial representation of the space of translation in the form of an RTN, which is then transformed either to WFSAs or to PDAs using the <a class="el" href="intro.html#OpenFst">OpenFst</a> <a href="http://openfst.org/twiki/bin/view/FST/ReplaceDoc">Replace</a> operation prior to application of the language model. This leads to two alternative translation pipelines starting from the RTNs (see Figure 2 <a class="el" href="intro.html#Allauzen2014">Allauzen2014</a>). Both piplines start with RTNs containing translation grammar scores alone, however in the HiPDT pipeline, WFSAs are not created until after the LM is applied to the translations:</p>
<ul>
<li>HiFST: Translation via WFSAs<ul>
<li>RTNs are transformed to WFSAs by the OpenFst <a href="http://openfst.org/twiki/bin/view/FST/ReplaceDoc">fstreplace</a> operation</li>
<li>WFSAs are intersected with LMs</li>
<li>The WFSA is pruned under the combined translation grammar and LM scores</li>
</ul>
</li>
<li>HiPDT: Translation via PDTs<ul>
<li>RTNs are transformed to PDAs via the OpenFst <a href="http://www.openfst.org/twiki/bin/view/FST/FstExtensions">pdtreplace</a> operation</li>
<li>PDAs are intersected with the LMs</li>
<li>WFSAs are generated from PDAs via pruned Expansion</li>
<li>The WFSA is further pruned under the combined translation grammar and LM scores</li>
</ul>
</li>
</ul>
<p>In HiPDT, the RTN at the top-most cell of the CYK grid is converted into a PDA (via the Replace operation in the OpenFst Extensions) and efficiently composed with a language model to produce another PDA. To obtain the final output FSA, the PDA is expanded to an FSA either entirely (if memory is sufficient and the language model is small enough) or via pruned expansion (for larger language models). This is useful in exploring large and complex translation grammars where HiFST requires a lot of local pruning. However, it requires the language model to be 'small' (for example, entropy-pruned as in [<a class="el" href="intro.html#Iglesias2011">Iglesias2011</a>, <a class="el" href="intro.html#Allauzen2014">Allauzen2014</a>]). Therefore, we then typically rescore the pruned output FSA with a stronger language model.</p>
<p>Both the HiFST and the HiPDT pipelines are implemented by the HiFST program, and are run here with the Shallow-1 translation grammar and the 4-gram language model: </p><pre class="fragment">&gt; hifst.${TGTBINMK}.bin --config=configs/CF.baseline
&gt; hifst.${TGTBINMK}.bin --config=configs/CF.baseline.pdt
</pre><p>Translation via PDTs uses more memory (as described in <a class="el" href="intro.html#Allauzen2014">Allauzen2014</a>), both otherwise the outputs should be identical: </p><pre class="fragment">&gt; printstrings.${TGTBINMK}.bin --semiring=lexstdarc -u --input=output/exp.baseline/LATS/1.fst.gz --label-map=wmaps/wmt13.en.wmap -w
...
&lt;s&gt; parliament does not support the amendment , which gives you the freedom of tymoshenko &lt;/s&gt;  42.6999,-19.4512

&gt; printstrings.${TGTBINMK}.bin --semiring=lexstdarc -u --input=output/exp.baseline.pdt/LATS/1.fst.gz --label-map=wmaps/wmt13.en.wmap -w
...
&lt;s&gt; parliament does not support the amendment , which gives you the freedom of tymoshenko &lt;/s&gt;  42.6999,-19.4512
</pre><p>The following two sections uses the OpenFST command line tools to show the details of the HiFST and the HiPDT pipelines.</p><ul>
<li>Using HiFST to generate RTNs is described in section <a class="el" href="pda.html#pda_rtns">Generating RTNs</a></li>
<li>The HiFST pipeline is described in section <a class="el" href="pda.html#pda_rtn_expansion">Translation by RTN Expansion to WFSAs</a></li>
<li>The HiPDT pipeline is described in section <a class="el" href="pda.html#pda_pda_expand">Translation by PDA Pruned Expansion</a></li>
</ul>
<h1><a class="anchor" id="pda_rtns"></a>
Generating RTNs</h1>
<p>Translation can be re-run, but with added instructions to save the RTNs to disk: </p><pre class="fragment">&gt; hifst.${TGTBINMK}.bin --config=configs/CF.baseline --hifst.writertn=output/exp.baseline/rtn/?/%%rtn_label%%.fst --grammar.storentorder=output/exp.baseline/rtn/ntmap  --hifst.rtnopt=yes &amp;&gt; log/log.baseline.rtn
</pre><p>The RTNs are written to the directory <code>output/exp.baseline/rtn/*</code> as </p><pre class="fragment">&gt; ls output/exp.baseline/rtn/1/
1001000009.fst  1003002003.fst 1003003002.fst   1003005001.fst 1003006001.fst   1004001001.fst  1004003000.fst  1004004001.fst  1004006000.fst
1003002001.fst  1003002004.fst 1003004001.fst   1003005002.fst 1003007001.fst   1004002000.fst  1004003001.fst  1004005000.fst  1004007000.fst
1003002002.fst  1003003001.fst 1003004002.fst   1003005003.fst 1004001000.fst   1004002001.fst  1004004000.fst  1004005001.fst  1004008000.fst
</pre><p>and the non-terminal mapping is written to output/exp.baseline/rtn/ntmap : </p><pre class="fragment">&gt; cat output/exp.baseline/rtn/ntmap
S   1
D   2
X   3
V   4
</pre><p>Each RTN name is of the form 1ABC.fst , where A, B, and C are 3-digit strings.</p><ul>
<li>A is the numerical code for a non-terminal in the grammar; in this case, 001 corresponds to S.</li>
<li>B indicates a position in the source sentence: 0 &lt;= B &lt; I, where I is the source sentence length</li>
<li>C indicates the offset to the end of a span, 0 &lt;= C and B+C &lt; I</li>
<li>The automata 1ABC.fst corresponds to T_(A,B,B+C) in the formulation of <a class="el" href="basictrans.html#lpruning">Inadmissible Pruning</a></li>
</ul>
<p>In this example, the automata 1003002002.fst contains all derivations headed by X, the third non-terminal, and spanning source positions 2 to 4 (=2+2).</p>
<p>The root automata is 1001000009.fst, since A=001 (the S non-terminal), B=0 (the first source position), and C=9 (the sentence has 10 words).</p>
<p>The automata is a representation of all possible translations of the source sentence under this grammar, as can be seen by printing its paths (here the first 5): </p><pre class="fragment">&gt; printstrings.${TGTBINMK}.bin --semiring=lexstdarc -u --nbest=5 --input=output/exp.baseline/rtn/1/1001000009.fst 
...
1 1004001000 135 20 103 1004004000 1004005000 1004006000 1004007000 1004008000 2 
1 1004001000 135 20 103 1004004000 1004005000 1003006001 1004008000 2 
1 1004001000 135 20 103 1004004000 1003005001 1004007000 1004008000 2 
1 1004001000 135 20 103 1003004001 1004006000 1004007000 1004008000 2 
1 1004001000 135 20 103 1004004000 1004005000 1004006000 1003007001 2 
...
</pre><p>As can be seen, the symbols are a mix of target language symbols (1,135,20,102,2,...) and pointers to other automata (1004004000, 1004005000, ...). Conversion of the RTN is done by recursive substitution of these symbols by the FSTs to which they point, starting from the root automata.</p>
<h1><a class="anchor" id="pda_rtn_expansion"></a>
Translation by RTN Expansion to WFSAs</h1>
<p>The <code>fstreplace</code> command is used to expand the collection of WFSAs comprising the RTN into a single equivalent WFSA. </p><pre class="fragment"> &gt; fstreplace | head -n 3
 Recursively replaces FST arcs with other FST(s).

 Usage: fstreplace root.fst rootlabel [rule1.fst label1 ...] [out.fst]
</pre><p>Note that the root FST and root label are always of the form 1001000C, where C = I - 1 , where I is the source sentence length. HiFST uses the same names for rules and labels, so we get get the filenames and labels in the right form by, e.g. </p><pre class="fragment"> &gt; ls output/exp.baseline/rtn/1/1*.fst | sed 's,\(.*\)/\(.*\).fst,\1/\2.fst \2,' &gt; tmp/script.replace
 &gt; head -2 tmp/script.replace
 output/exp.baseline/rtn/1/1001000009.fst 1001000009
 output/exp.baseline/rtn/1/1003002001.fst 1003002001
</pre><p>The following will expand the RTN into an FSA: </p><pre class="fragment"> &gt; fstreplace `cat tmp/script.replace` &gt; output/exp.baseline/rtn/1/T.fst
</pre><p>The WFSA <code>output/exp.baseline/rtn/1/T.fst</code> is the replacement of the RTN that was generated in translation. It is a transducer: the input maintains the pointers to the automata used in translating each source span; the output is the corresponding translation </p><pre class="fragment"> &gt; fstproject output/exp.baseline/rtn/1/T.fst | fstrmepsilon | printstrings.${TGTBINMK}.bin --semiring=lexstdarc -u --nbest=5 -w
 ...
 1 1004001000 50 6 3 1003002002 1004002001 135 20 103 3 34 245 1004005000 4 1004006000 33 31 3 154 82 1145 1003007001 1004007000 3 425 6 23899 2       -29.123,-29.123
 1 1004001000 50 6 3 1003002002 1004002001 135 20 103 3 34 245 1003005001 4 1004006000 33 31 3 154 82 1145 1003007001 1004007000 3 425 6 23899 2       -29.0996,-29.0996
 1 1004001000 50 6 3 1003002002 1004002001 135 20 103 3 34 245 1004005000 4 1004006000 33 31 3 154 82 1145 1004007000 3 425 6 1004008000 23899 2       -29.0801,-29.0801
 1 1004001000 50 6 3 1003002002 1004002001 135 20 103 3 34 245 1003005001 4 1004006000 33 31 3 154 82 1145 1004007000 3 425 6 1004008000 23899 2       -29.0566,-29.0566
 1 1004001000 50 6 3 1003002002 1004002001 135 20 103 3 34 245 1004005000 4 1004006000 33 31 3 154 82 1145 1003007001 425 6 3 1004008000 23899 2       -29.0537,-29.0537
 ...

 &gt; fstproject --project_output output/exp.baseline/rtn/1/T.fst | fstrmepsilon | printstrings.${TGTBINMK}.bin --semiring=lexstdarc -u --nbest=5 -w
 ...
 1 50 6 3 135 20 103 3 34 245 4 33 31 3 154 82 1145 3 425 6 23899 2      -29.123,-29.123
 1 50 6 3 135 20 103 3 34 245 4 33 31 3 154 82 1145 425 6 3 23899 2      -29.0537,-29.0537
 1 50 6 3 135 20 103 3 34 245 4 3 33 31 3 154 82 1145 3 425 6 23899 2    -29.0518,-29.0518
 1 50 6 3 135 20 103 3 34 245 4 3 33 31 3 154 82 1145 425 6 3 23899 2    -28.9824,-28.9824
 1 3 50 6 135 20 103 3 34 245 4 33 31 3 154 82 1145 3 425 6 23899 2      -28.9463,-28.9463
</pre><h2><a class="anchor" id="rtn_lm_app"></a>
Applying the LM to the WFSA</h2>
<p>The <code>applylm</code> tool can be used to apply the baseline 4-gram language model to T via composition. This generates a new WFSA containing both grammar and language model scores:</p>
<ul>
<li>Input<ul>
<li>M/interp.4g.arpa.newstest2012.tune.corenlp.ru.idx.withoptions.mmap : n-gram LM</li>
<li>output/exp.baseline/rtn/1/T.fst : WFSA containing translation grammar scores</li>
</ul>
</li>
<li>Output<ul>
<li>output/exp.baseline/rtn/1/TG.fst : WFSA containing translation grammar and LM scores</li>
</ul>
</li>
</ul>
<p>The output is written in the form of a transducer, with the RTN labels as the input symbols and the target language words on the output symbols: </p><pre class="fragment">&gt; applylm.${TGTBINMK}.bin --lm.load=M/interp.4g.arpa.newstest2012.tune.corenlp.ru.idx.withoptions.mmap --semiring=lexstdarc --lattice.load=output/exp.baseline/rtn/1/T.fst --lattice.store=output/exp.baseline/rtn/1/TG.fst
&gt; fstshortestpath output/exp.baseline/rtn/1/TG.fst | fstrmepsilon | fsttopsort | fstprint | head
0     1     1     1   -2.68554688,-2.68554688
1     2 1004001000     0   
2     3    50    50   6.39422989,-2.88476562
3     4 1003002002     0   1.53515625,1.53515625
4     5   135   135   -0.098549366,-6.18554688
5     6    20    20   0.961314559,0
6     7   103   103   4.64596272,0
7     8     3     3   0.961314559,0
8     9 1004004000     0   
9    10   245   245   5.13327551,-0.48828125
</pre><p>To see the translation alone, we project to the output symbols:</p>
<pre class="fragment">&gt; printstrings.${TGTBINMK}.bin --semiring=lexstdarc -w -m wmaps/wmt13.en.wmap --print-output-labels --input=output/exp.baseline/rtn/1/TG.fst
...
&lt;s&gt; parliament does not support the amendment , which gives you the freedom of tymoshenko &lt;/s&gt;  42.6999,-19.4512
</pre><p>which should agree with the previously generated contents of output/exp.baseline/LATS/1.fst.gz produced by the baseline system: </p><pre class="fragment">&gt; printstrings.${TGTBINMK}.bin --semiring=lexstdarc -w -m wmaps/wmt13.en.wmap --input=output/exp.baseline/LATS/1.fst.gz
&lt;s&gt; parliament does not support the amendment , which gives you the freedom of tymoshenko &lt;/s&gt;  42.6999,-19.4512
</pre><h1><a class="anchor" id="pda_pda_expand"></a>
Translation by PDA Pruned Expansion</h1>
<p>(Note, as of July 2015: The OpenFST PDT command line operations do not work well with our lexicographic library, so the standard tropical semirring must be used in this example. This makes the example slightly more complex than it actually is in practice.)</p>
<p><b>Step 0.</b> Dump the RTN under the full translation grammar, as described in <a class="el" href="pda.html#pda_rtns">Generating RTNs</a> </p><pre class="fragment">&gt; hifst.${TGTBINMK}.bin --config=configs/CF.baseline --hifst.writertn=output/exp.baseline/rtn/?/%%rtn_label%%.fst --grammar.storentorder=output/exp.baseline/rtn/ntmap  --hifst.rtnopt=yes &amp;&gt; log/log.baseline.rtn
</pre><p><b>Note</b> that that translations under the grammar <code>G/rules.shallow.gz</code> and LM <code>M/interp.4g.arpa.newstest2012.tune.corenlp.ru.idx.withoptions.mmap</code> are written to the FST <code>output/exp.baseline/LATS/1.fst.gz</code> in the usual way. However the RTN is written to the directory <code>output/exp.baseline/rtn/1/</code> <em>without</em> the language model score.</p>
<p><b>Step 2.</b> Use <code>lexmap</code> to transform the RTN files <code>output/exp.baseline/rtn/1/100*.fst</code> into in the standard tropical semiring (<code>output/exp.baseline/rtn/1/100*.fst-tp</code>): </p><pre class="fragment">&gt; for f in output/exp.baseline/rtn/1/100*.fst; do lexmap.${TGTBINMK}.bin --action=lex2std --input=$f &gt; $f-tp; done;
</pre><p><b>Step 3.</b> Transform the RTN into a PDT: </p><pre class="fragment">&gt; ls output/exp.baseline/rtn/1/1*.fst-tp | sed 's,\(.*\)/\(.*\).fst-tp,\1/\2.fst-tp \2,' &gt; output/exp.baseline/rtn/1/script.replace
&gt; pdtreplace --pdt_parentheses=output/exp.baseline/rtn/1/parens.txt `cat output/exp.baseline/rtn/1/script.replace` &gt; output/exp.baseline/rtn/1/T.pdt
</pre><p>where the `pdt_parentheses' option indicates that the open/close parentheses symbols are to be stored into a file; note that this file varies with the translations. This is used later in order to expand the PDA to an FSA.</p>
<p><b>Step 4.</b> Compose the PDA with the weak language model. This is done via the standard composition algorithm, but making sure that open/close parentheses symbols are treated as epsilons by the composition algorithm. To accomplish this, their respective output symbols need to be relabelled to 0 before applying the LM: </p><pre class="fragment"># relabel
&gt; tr '\t' '\n' &lt; output/exp.baseline/rtn/1/parens.txt | sed 's/$/\t0/' &gt; output/exp.baseline/rtn/1/parens-to-epsilon.txt 
&gt; fstrelabel -relabel_opairs=output/exp.baseline/rtn/1//parens-to-epsilon.txt output/exp.baseline/rtn/1/T.pdt &gt; output/exp.baseline/rtn/1/Tb.pdt
# apply LMs
&gt; applylm.${TGTBINMK}.bin --lm.load=M/interp.4g.arpa.newstest2012.tune.corenlp.ru.idx.withoptions.mmap --lattice.load=output/exp.baseline/rtn/1/Tb.pdt --lattice.store=output/exp.baseline/rtn/1/TG.pdt 
</pre><p><b>Step 5.</b> Expand the resulting PDT into an FSA while applying a pruning weight of 9: </p><pre class="fragment">&gt; fstproject output/exp.baseline/rtn/1/TG.pdt | pdtexpand --pdt_parentheses=output/exp.baseline/rtn/1/parens.txt --weight=9 &gt; output/exp.baseline/rtn/1/TG.fst
</pre><p>The translation result following pruned expansion of the PDT should agree with the translation hypothesis produced directly by HiFST: </p><pre class="fragment">&gt; printstrings.${TGTBINMK}.bin --semiring=lexstdarc -w -m wmaps/wmt13.en.wmap --input=output/exp.baseline/LATS/1.fst.gz
...
&lt;s&gt; parliament does not support the amendment , which gives you the freedom of tymoshenko &lt;/s&gt;  42.6999,-19.4512
...

&gt; printstrings.${TGTBINMK}.bin -w -m wmaps/wmt13.en.wmap --input=output/exp.baseline/rtn/1/TG.fst
...
&lt;s&gt; parliament does not support the amendment , which gives you the freedom of tymoshenko &lt;/s&gt;  42.6999
...
</pre><p><b>Step 6. (optional)</b> Remove the pruned LM and apply the full LM. The language model <code>M/interp.4g.arpa.newstest2012.tune.corenlp.ru.idx.withoptions.mmap</code> is a heavily pruned version of <code>M/interp.4g.arpa.newstest2012.tune.corenlp.ru.idx.union.mmap</code>. <b>Note</b> that the larger LM will have to be installed and uncompressed as described in <a class="el" href="build.html#tutorial_install">Tutorial Installation</a>. </p><pre class="fragment"># remove the pruned LM
# since .../1/TG.fst is not lexicographic form, we subtract the pruned lm scores and write a version of the FST with translation scores only 
&gt; applylm.${TGTBINMK}.bin --lm.load=M/interp.4g.arpa.newstest2012.tune.corenlp.ru.idx.withoptions.mmap --lm.featureweights=-1 --lattice.load=output/exp.baseline/rtn/1/TG.fst --lattice.store=output/exp.baseline/rtn/1/TG-nolm.fst  
# apply the strong LM
&gt; applylm.${TGTBINMK}.bin --lm.load=M/interp.4g.arpa.newstest2012.tune.corenlp.ru.idx.union.mmap --lattice.load=output/exp.baseline/rtn/1/TG-nolm.fst --lattice.store=output/exp.baseline/rtn/1/TG-final.fst
</pre><p>The final FSA that results from this process (<code>output/exp.baseline/rtn/1/TG-final.fst</code>) contains translations under the Hiero grammar with the full, unpruned LM: </p><pre class="fragment">&gt; printstrings.${TGTBINMK}.bin -w -m wmaps/wmt13.en.wmap --input=output/exp.baseline/rtn/1/TG-final.fst
...
&lt;s&gt; parliament does not support the amendment , which gives you the freedom of tymoshenko &lt;/s&gt;  43.093
</pre><p>The overall score changes, due to the bigger LM, but the top hypothesis is unchanged. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Tue Dec 8 2015 13:11:46 for Cambridge SMT System by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.9.1 </li>
  </ul>
</div>
</body>
</html>
