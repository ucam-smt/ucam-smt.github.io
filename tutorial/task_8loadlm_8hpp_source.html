<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.4"/>
<title>Cambridge SMT System: task.loadlm.hpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Cambridge SMT System
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.4 -->
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('task_8loadlm_8hpp_source.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">task.loadlm.hpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="task_8loadlm_8hpp.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">// you may not use these files except in compliance with the License.</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">// You may obtain a copy of the License at</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">//    http://www.apache.org/licenses/LICENSE-2.0</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">// Unless required by applicable law or agreed to in writing, software</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">// distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">// See the License for the specific language governing permissions and</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">// limitations under the License.</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">// Copyright 2012 - Gonzalo Iglesias, Adrià de Gispert, William Byrne</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor">#ifndef LOADLMTASK_HPP</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define LOADLMTASK_HPP</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="preprocessor">#include &lt;lm/config.hh&gt;</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="preprocessor">#include &lt;lm/enumerate_vocab.hh&gt;</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="idbridge_8hpp.html" title="maps between grammar targets ids and lm ids ">idbridge.hpp</a>&gt;</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="hifst__enumerate__vocab_8hpp.html" title="Extend EnumerateVocab to access kenlm ids. ">hifst_enumerate_vocab.hpp</a>&gt;</span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="keyword">namespace </span>ucam {</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="keyword">namespace </span>fsttools {</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="keyword">template</span> &lt;<span class="keyword">class</span> Data, <span class="keyword">class</span> KenLMModelT = lm::ngram::Model &gt;</div>
<div class="line"><a name="l00040"></a><span class="lineno"><a class="code" href="classucam_1_1fsttools_1_1LoadLanguageModelTask.html">   40</a></span>&#160;<span class="keyword">class </span><a class="code" href="classucam_1_1fsttools_1_1LoadLanguageModelTask.html" title="Language model loader task, loads a language model wrapping it in a class to provide. ">LoadLanguageModelTask</a>: <span class="keyword">public</span> <a class="code" href="classucam_1_1util_1_1TaskInterface.html" title="Templated (hybrid) Interface for Task classes. ">ucam::util::TaskInterface</a>&lt;Data&gt; {</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160; <span class="keyword">private</span>:</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;  <span class="keywordtype">bool</span> built_;</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;  <a class="code" href="classucam_1_1util_1_1PatternAddress.html" title="class that expands a wildcard into its actual value. This is useful e.g. for filenames ranging severa...">ucam::util::IntegerPatternAddress</a> lmfile_;</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;  std::string previous_;</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;  uint lmo_;</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;  <a class="code" href="structucam_1_1fsttools_1_1KenLMData.html" title="Language Model data structure. ">KenLMData&lt;KenLMModelT&gt;</a> kld_;</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;  uint index_;</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;  std::string lmkey_;</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;  <span class="keyword">const</span> <a class="code" href="classucam_1_1util_1_1RegistryPO.html">ucam::util::RegistryPO</a>&amp; rg_;</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;  <span class="keyword">const</span> std::string wordmapkey_;</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;  <span class="keywordtype">bool</span> isintegermapped_;</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160; <span class="keyword">public</span>:</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;</div>
<div class="line"><a name="l00077"></a><span class="lineno"><a class="code" href="classucam_1_1fsttools_1_1LoadLanguageModelTask.html#ac0709093d9be932369748db1f5a0652a">   77</a></span>&#160;  <a class="code" href="classucam_1_1fsttools_1_1LoadLanguageModelTask.html#ac0709093d9be932369748db1f5a0652a" title="Public constructor. If the user wants to load several language models (e.g. –lm.load=lm1,lm2,lm3,lm4 and –lm.scale=0.25,0.25,0.25 ), the second and following instances of LoadLanguageModelTask will be created using the private constructor (see below), which has an index to the actual language model that must be loaded. For the public constructor, the index is set to 0. ">LoadLanguageModelTask</a> ( <span class="keyword">const</span> <a class="code" href="classucam_1_1util_1_1RegistryPO.html">ucam::util::RegistryPO</a>&amp; rg ,</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;                          <span class="keyword">const</span> std::string&amp; lmload = <a class="code" href="namespaceHifstConstants.html#aa42b4603e57486c7d8509f7495f776fc">HifstConstants::kLmLoad</a> ,</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;                          <span class="keyword">const</span> std::string&amp; lmscale =</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;                            <a class="code" href="namespaceHifstConstants.html#a922a20cdf8305f360766bea0e7790127">HifstConstants::kLmFeatureweights</a>,  <span class="comment">//if rg.get(lmscale)==&quot;&quot; the scale will default to 1</span></div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;                          <span class="keyword">const</span> std::string&amp; lmwp =</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;                            <a class="code" href="namespaceHifstConstants.html#a746bc28f6755d48e152a1c08ea843c42">HifstConstants::kLmWordPenalty</a>,  <span class="comment">//if rg.get(wps)==&quot;&quot; the scale will default to 0</span></div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;                          <span class="keyword">const</span> std::string&amp; wordmapkey = <a class="code" href="namespaceHifstConstants.html#a9e5c8ac3695644e1b68f452186684ad2">HifstConstants::kLmWordmap</a>,</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;                          <span class="keywordtype">bool</span> forceone = <span class="keyword">false</span></div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;                        ) :</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;    rg_ ( rg ),</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;    lmkey_ ( lmload ),</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;    previous_ ( <span class="stringliteral">&quot;&quot;</span> ),</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;    built_ ( false ),</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;    index_ ( 0 ),</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;    isintegermapped_ (!rg.<a class="code" href="namespaceucam_1_1util.html#a63f2e665e982de5cc1e2a601cb559de1" title="Convenience function to find out whether a needle exists in a text. ">exists</a> (wordmapkey)</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;                      || rg.get&lt;std::string&gt; (wordmapkey) == <span class="stringliteral">&quot;&quot;</span>),</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;    wordmapkey_ (wordmapkey),</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;    lmfile_ ( rg.getVectorString ( lmload , 0 ) ) {</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;    <a class="code" href="logger_8boost__log_8hpp.html#adf127ca2262cc160830da49c37d04e85">LINFO</a> ( <span class="stringliteral">&quot;LM loader using parameters &quot;</span> &lt;&lt; lmload &lt;&lt; <span class="stringliteral">&quot;/&quot;</span> &lt;&lt; lmscale &lt;&lt; <span class="stringliteral">&quot;/&quot;</span> &lt;&lt; lmwp</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;            &lt;&lt; <span class="stringliteral">&quot;, and key &quot;</span> &lt;&lt; lmkey_  &lt;&lt; <span class="stringliteral">&quot;,index=&quot;</span> &lt;&lt; index_ &lt;&lt; <span class="stringliteral">&quot;,wordmap=&quot;</span> &lt;&lt;</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;            wordmapkey_);</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;    setLanguageModelScale ( lmscale );</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;    setLanguageModelWordPenalty ( lmwp );</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;    <span class="keywordflow">if</span> ( rg_.<a class="code" href="classucam_1_1util_1_1RegistryPO.html#a498b76353f978a417809cc13bdce9954" title="Convenience method that returns a vector of strings taking &quot;,&quot; as the separator character. ">getVectorString</a> ( lmload ).size() &gt; 1 ) {</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;      <span class="keywordflow">if</span> ( !forceone ) {</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;        <a class="code" href="logger_8boost__log_8hpp.html#adf127ca2262cc160830da49c37d04e85">LINFO</a> ( <span class="stringliteral">&quot;Appending Language model...&quot;</span> );</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;        this-&gt;<a class="code" href="classucam_1_1util_1_1TaskInterface.html#ab4cbde1f927b89d774b0dbbcb97f0760" title="Appends a task class. If there is no task, append here, otherwise delegate in next task...">appendTask</a> ( <span class="keyword">new</span> <a class="code" href="classucam_1_1fsttools_1_1LoadLanguageModelTask.html" title="Language model loader task, loads a language model wrapping it in a class to provide. ">LoadLanguageModelTask</a> ( rg_, 1, lmload, lmscale , lmwp ,</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;                           wordmapkey ) );</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;      } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;        <a class="code" href="logger_8boost__log_8hpp.html#a6ffaab1d2d66f7f82bb45ce32e7e48e4">LWARN</a> ( <span class="stringliteral">&quot;Only one loaded for &quot;</span> &lt;&lt; lmload &lt;&lt;</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;                <span class="stringliteral">&quot;. Extra language models are being ignored&quot;</span> );</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;      }</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;    }</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;    <a class="code" href="logger_8boost__log_8hpp.html#adf127ca2262cc160830da49c37d04e85">LINFO</a> ( <span class="stringliteral">&quot;Finished constructor!&quot;</span> );</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;  };</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;</div>
<div class="line"><a name="l00118"></a><span class="lineno"><a class="code" href="classucam_1_1fsttools_1_1LoadLanguageModelTask.html#a1d1492542bc40e72a2503864cfa4409b">  118</a></span>&#160;  <span class="keywordtype">bool</span> <a class="code" href="classucam_1_1fsttools_1_1LoadLanguageModelTask.html#a1d1492542bc40e72a2503864cfa4409b" title="Method inherited from TaskInterface. Loads the language model and stores in lm data structure...">run</a> ( Data&amp; d ) {</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;    <a class="code" href="logger_8boost__log_8hpp.html#adf127ca2262cc160830da49c37d04e85">LINFO</a> ( <span class="stringliteral">&quot;run!&quot;</span> );</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;    <span class="keywordflow">if</span> ( lmfile_() == <span class="stringliteral">&quot;&quot;</span> ) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;    <span class="comment">// No need to build again...</span></div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;    <span class="keywordflow">if</span> ( built_ &amp;&amp; previous_ == lmfile_ ( d.sidx ) ) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;    <a class="code" href="classucam_1_1fsttools_1_1LoadLanguageModelTask.html#a037df960e6cdb995f366cbae13467fb4" title="Free language model resources. Returns true if ok, false if otherwise. ">close</a>();</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;    <a class="code" href="logger_8boost__log_8hpp.html#a0ffb18b9a8e38dc6c286330ecde7b330">FORCELINFO</a> ( <span class="stringliteral">&quot;loading LM=&quot;</span> &lt;&lt; lmfile_ ( d.sidx ) );</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;    d.stats-&gt;setTimeStart (<span class="stringliteral">&quot;lm-load-&quot;</span> + index_ );</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;    lm::ngram::Config kenlm_config;</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;    <span class="comment">// If lm is not integermapped, then we will need a proper grammar target wordmap.</span></div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;    <span class="comment">// Make sure we have it.</span></div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;    <a class="code" href="classucam_1_1util_1_1WordMapper.html" title="Loads efficiently a wordmap file and provides methods to map word-to-integer or integer-to-word. To avoid memory footprint issues, hashing the wordmap entries is avoided. ">ucam::util::WordMapper</a> *wm = NULL;</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;    <span class="keywordflow">if</span> (!isintegermapped_) {</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;      <a class="code" href="logger_8boost__log_8hpp.html#adf127ca2262cc160830da49c37d04e85">LINFO</a> (<span class="stringliteral">&quot;Using wordmap &quot;</span> &lt;&lt; wordmapkey_);</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;      <a class="code" href="logger_8boost__log_8hpp.html#adf127ca2262cc160830da49c37d04e85">LINFO</a> (<span class="stringliteral">&quot;There are &quot;</span> &lt;&lt; d.wm.size() &lt;&lt; <span class="stringliteral">&quot; wordmaps&quot;</span>);</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;      <a class="code" href="custom__assert_8hpp.html#a9c40815aec8dd07daee741da5b494a35" title="Tests whether exp is true. If not, comment is printed and program ends. ">USER_CHECK</a> (d.wm.find (wordmapkey_) != d.wm.end()</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;                  , <span class="stringliteral">&quot;Language model provided over words instead of integers. A target wordmap is required! &quot;</span>);</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;      wm = d.wm[wordmapkey_];</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;    }</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;    <a class="code" href="classlm_1_1HifstEnumerateVocab.html" title="This class extends EnumerateVocab in kenlm code. This class creates a grammar-integer to lm-integer h...">lm::HifstEnumerateVocab</a> hev (kld_.idb, wm);</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;    kenlm_config.enumerate_vocab = &amp;hev;</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;    kld_.model = <span class="keyword">new</span> KenLMModelT ( lmfile_ ( d.sidx ).c_str() , kenlm_config);</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;    d.stats-&gt;setTimeEnd (<span class="stringliteral">&quot;lm-load-&quot;</span> + index_ );</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;    previous_ = lmfile_ ( d.sidx );</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;    built_ = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;    <span class="keywordflow">if</span> ( d.klm.find ( lmkey_ ) == d.klm.end() ) d.klm[lmkey_].resize ( index_ + 1 );</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( d.klm[lmkey_].size() &lt; index_ + 1 ) d.klm[lmkey_].resize (</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;        index_ + 1 );</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;    d.klm[lmkey_][index_] = &amp;kld_;</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;    <a class="code" href="logger_8boost__log_8hpp.html#a136d9d772791ddd40a7781b0f6b01dd6">LDEBUG</a> ( <span class="stringliteral">&quot;LM &quot;</span> &lt;&lt; lmfile_ ( d.sidx ) &lt;&lt; <span class="stringliteral">&quot; loaded, key=&quot;</span> &lt;&lt; lmkey_ &lt;&lt;</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;             <span class="stringliteral">&quot;, position=&quot;</span> &lt;&lt;  toString&lt;uint&gt; ( d.klm[lmkey_].size() - 1 ) &lt;&lt;</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;             <span class="stringliteral">&quot;,total number of language models for this key is &quot;</span> &lt;&lt; d.klm[lmkey_].size() );</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;  };</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;</div>
<div class="line"><a name="l00154"></a><span class="lineno"><a class="code" href="classucam_1_1fsttools_1_1LoadLanguageModelTask.html#a037df960e6cdb995f366cbae13467fb4">  154</a></span>&#160;  <span class="keywordtype">bool</span> <a class="code" href="classucam_1_1fsttools_1_1LoadLanguageModelTask.html#a037df960e6cdb995f366cbae13467fb4" title="Free language model resources. Returns true if ok, false if otherwise. ">close</a>() {</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;    <span class="keywordflow">if</span> ( kld_.model != NULL ) {</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;      <a class="code" href="logger_8boost__log_8hpp.html#adf127ca2262cc160830da49c37d04e85">LINFO</a> ( <span class="stringliteral">&quot;Releasing language model resources...&quot;</span> );</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;      <span class="keyword">delete</span> kld_.model;</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;      kld_.model = NULL;</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;      built_ = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;      <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;    }</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;  }</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;</div>
<div class="line"><a name="l00166"></a><span class="lineno"><a class="code" href="classucam_1_1fsttools_1_1LoadLanguageModelTask.html#a740ab7b4fbc2a801b12d146e5f1624d8">  166</a></span>&#160;  <a class="code" href="classucam_1_1fsttools_1_1LoadLanguageModelTask.html#a740ab7b4fbc2a801b12d146e5f1624d8" title="Destructor. ">~LoadLanguageModelTask</a>() {</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;    <a class="code" href="classucam_1_1fsttools_1_1LoadLanguageModelTask.html#a037df960e6cdb995f366cbae13467fb4" title="Free language model resources. Returns true if ok, false if otherwise. ">close</a>();</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;  }</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160; <span class="keyword">private</span>:</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;  <a class="code" href="classucam_1_1fsttools_1_1LoadLanguageModelTask.html#ac0709093d9be932369748db1f5a0652a" title="Public constructor. If the user wants to load several language models (e.g. –lm.load=lm1,lm2,lm3,lm4 and –lm.scale=0.25,0.25,0.25 ), the second and following instances of LoadLanguageModelTask will be created using the private constructor (see below), which has an index to the actual language model that must be loaded. For the public constructor, the index is set to 0. ">LoadLanguageModelTask</a> ( <span class="keyword">const</span> <a class="code" href="classucam_1_1util_1_1RegistryPO.html">ucam::util::RegistryPO</a>&amp; rg ,</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;                          uint index ,</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;                          <span class="keyword">const</span> std::string&amp; lmload = <a class="code" href="namespaceHifstConstants.html#aa42b4603e57486c7d8509f7495f776fc">HifstConstants::kLmLoad</a>,</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;                          <span class="keyword">const</span> std::string&amp; lmscale = <a class="code" href="namespaceHifstConstants.html#a922a20cdf8305f360766bea0e7790127">HifstConstants::kLmFeatureweights</a> ,</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;                          <span class="keyword">const</span> std::string&amp; lmwp = <a class="code" href="namespaceHifstConstants.html#a746bc28f6755d48e152a1c08ea843c42">HifstConstants::kLmWordPenalty</a>,</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;                          <span class="keyword">const</span> std::string&amp; wordmapkey = <a class="code" href="namespaceHifstConstants.html#a9e5c8ac3695644e1b68f452186684ad2">HifstConstants::kLmWordmap</a></div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;                        ) :</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;    rg_ ( rg ),</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;    lmkey_ ( lmload ),</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;    previous_ ( <span class="stringliteral">&quot;&quot;</span> ),</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;    built_ ( false ),</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;    index_ ( index ),</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;    isintegermapped_ (!rg.<a class="code" href="namespaceucam_1_1util.html#a63f2e665e982de5cc1e2a601cb559de1" title="Convenience function to find out whether a needle exists in a text. ">exists</a> (wordmapkey)</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;                      || rg.get&lt;std::string&gt; (wordmapkey) == <span class="stringliteral">&quot;&quot;</span>),</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;    wordmapkey_ (wordmapkey),</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;    lmfile_ ( rg.getVectorString ( lmload , index ) ) {</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;    <a class="code" href="logger_8boost__log_8hpp.html#adf127ca2262cc160830da49c37d04e85">LINFO</a> ( <span class="stringliteral">&quot;LM loader using parameters &quot;</span> &lt;&lt; lmload &lt;&lt; <span class="stringliteral">&quot;/&quot;</span> &lt;&lt; lmscale &lt;&lt;</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;            <span class="stringliteral">&quot;, and key &quot;</span> &lt;&lt; lmkey_  &lt;&lt; <span class="stringliteral">&quot;,index=&quot;</span> &lt;&lt; index_ &lt;&lt; <span class="stringliteral">&quot;,wordmapkey=&quot;</span> &lt;&lt;</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;            wordmapkey_);</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;    setLanguageModelScale ( lmscale );</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;    setLanguageModelWordPenalty ( lmwp );</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;    <span class="keywordflow">if</span> ( rg.<a class="code" href="classucam_1_1util_1_1RegistryPO.html#a498b76353f978a417809cc13bdce9954" title="Convenience method that returns a vector of strings taking &quot;,&quot; as the separator character. ">getVectorString</a> ( lmload ).size() &gt; index_ + 1 ) {</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;      <a class="code" href="logger_8boost__log_8hpp.html#adf127ca2262cc160830da49c37d04e85">LINFO</a> ( <span class="stringliteral">&quot;Appending Language model...&quot;</span> );</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;      this-&gt;<a class="code" href="classucam_1_1util_1_1TaskInterface.html#ab4cbde1f927b89d774b0dbbcb97f0760" title="Appends a task class. If there is no task, append here, otherwise delegate in next task...">appendTask</a> ( <span class="keyword">new</span> <a class="code" href="classucam_1_1fsttools_1_1LoadLanguageModelTask.html" title="Language model loader task, loads a language model wrapping it in a class to provide. ">LoadLanguageModelTask</a> ( rg, index_ + 1, lmload, lmscale ,</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;                         lmwp , wordmapkey ) );</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;    }</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;    <a class="code" href="logger_8boost__log_8hpp.html#adf127ca2262cc160830da49c37d04e85">LINFO</a> ( <span class="stringliteral">&quot;Ready!&quot;</span> );</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;  };</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;  <span class="keywordtype">void</span> setLanguageModelScale ( <span class="keyword">const</span> std::string&amp; lmscale ) {</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;    kld_.lmscale = 1.0f;</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;    <span class="keywordflow">if</span> (!rg_.<a class="code" href="classucam_1_1util_1_1RegistryPO.html#a72d753211a30f0a1720a52e609780b37" title="Determines whether a program option (key) has been defined by the user. ">exists</a> (lmscale) ) {</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;      <a class="code" href="logger_8boost__log_8hpp.html#a0ffb18b9a8e38dc6c286330ecde7b330">FORCELINFO</a> ( <span class="stringliteral">&quot;Language model scale &quot;</span> &lt;&lt; index_  &lt;&lt; <span class="stringliteral">&quot; defaulting to 1.0f&quot;</span> );</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;      <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;    }</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;    <span class="keywordflow">if</span> (rg_.<a class="code" href="classucam_1_1util_1_1RegistryPO.html#ab0608436641ce579fbfe53480df0d5af" title="Returns parsed value associated to key. ">get</a>&lt;std::string&gt; (lmscale) == <span class="stringliteral">&quot;&quot;</span> ) {</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;      <a class="code" href="logger_8boost__log_8hpp.html#a0ffb18b9a8e38dc6c286330ecde7b330">FORCELINFO</a> ( <span class="stringliteral">&quot;Language model scale &quot;</span> &lt;&lt; index_  &lt;&lt; <span class="stringliteral">&quot; defaulting to 1.0f&quot;</span> );</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;      <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;    }</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;    std::string aux = rg_.<a class="code" href="classucam_1_1util_1_1RegistryPO.html#a498b76353f978a417809cc13bdce9954" title="Convenience method that returns a vector of strings taking &quot;,&quot; as the separator character. ">getVectorString</a> ( lmscale, index_ );</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;    kld_.lmscale = ucam::util::toNumber&lt;float&gt; ( aux );</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;    <a class="code" href="logger_8boost__log_8hpp.html#a0ffb18b9a8e38dc6c286330ecde7b330">FORCELINFO</a> (<span class="stringliteral">&quot;Language model scale &quot;</span> &lt;&lt; index_ &lt;&lt; <span class="stringliteral">&quot;=&quot;</span> &lt;&lt; aux );</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;  }</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;  <span class="keywordtype">void</span> setLanguageModelWordPenalty ( <span class="keyword">const</span> std::string&amp; lmwp ) {</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;    kld_.lmwp = 0.0f;</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;    <span class="keywordflow">if</span> (!rg_.<a class="code" href="classucam_1_1util_1_1RegistryPO.html#a72d753211a30f0a1720a52e609780b37" title="Determines whether a program option (key) has been defined by the user. ">exists</a> (lmwp) ) {</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;      <a class="code" href="logger_8boost__log_8hpp.html#a0ffb18b9a8e38dc6c286330ecde7b330">FORCELINFO</a> ( <span class="stringliteral">&quot;Language model word penalty &quot;</span> &lt;&lt; index_  &lt;&lt;</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;                   <span class="stringliteral">&quot; defaulting to 0.0f&quot;</span> );</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;      <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;    }</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;    <span class="keywordflow">if</span> (rg_.<a class="code" href="classucam_1_1util_1_1RegistryPO.html#ab0608436641ce579fbfe53480df0d5af" title="Returns parsed value associated to key. ">get</a>&lt;std::string&gt; (lmwp) == <span class="stringliteral">&quot;&quot;</span> ) {</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;      <a class="code" href="logger_8boost__log_8hpp.html#a0ffb18b9a8e38dc6c286330ecde7b330">FORCELINFO</a> ( <span class="stringliteral">&quot;Language model scale &quot;</span> &lt;&lt; index_  &lt;&lt; <span class="stringliteral">&quot; defaulting to 0.0f&quot;</span> );</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;      <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;    }</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;    std::string aux = rg_.<a class="code" href="classucam_1_1util_1_1RegistryPO.html#a498b76353f978a417809cc13bdce9954" title="Convenience method that returns a vector of strings taking &quot;,&quot; as the separator character. ">getVectorString</a> ( lmwp, index_ );</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;    kld_.lmwp = ucam::util::toNumber&lt;float&gt; ( aux );</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;    <a class="code" href="logger_8boost__log_8hpp.html#a0ffb18b9a8e38dc6c286330ecde7b330">FORCELINFO</a> ( <span class="stringliteral">&quot;Language model word penalty &quot;</span> &lt;&lt; index_  &lt;&lt;  <span class="stringliteral">&quot;=&quot;</span> &lt;&lt; aux );</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;  }</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;};</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;}</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;} <span class="comment">// end namespaces</span></div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;<span class="preprocessor">#endif</span></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_eb8c2c6c0b2d8322989ab36eca0d27a6.html">ucam-smt</a></li><li class="navelem"><a class="el" href="dir_a5648fe88103fecf788a5eab781d4af7.html">cpp</a></li><li class="navelem"><a class="el" href="dir_c68994a6a814f9b549bc3049b9444d16.html">fsttools</a></li><li class="navelem"><a class="el" href="dir_f2218ff7965608556f711288c47c4a16.html">include</a></li><li class="navelem"><a class="el" href="task_8loadlm_8hpp.html">task.loadlm.hpp</a></li>
    <li class="footer">Generated on Thu Aug 28 2014 20:20:04 for Cambridge SMT System by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.4 </li>
  </ul>
</div>
</body>
</html>
