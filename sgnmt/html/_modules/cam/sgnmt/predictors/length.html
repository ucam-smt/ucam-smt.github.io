

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>cam.sgnmt.predictors.length &mdash; SGNMT 1.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  

  
    <link rel="top" title="SGNMT 1.0 documentation" href="../../../../index.html"/>
        <link rel="up" title="Module code" href="../../../index.html"/> 

  
  <script src="../../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../../index.html" class="icon icon-home"> SGNMT
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../setup.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial.html">Tutorial: Basics (T2T)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial_pytorch.html">Tutorial: fairseq (PyTorch)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../adding_components.html">Tutorial: Adding new components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../bea19_gec.html">Tutorial:  Grammatical Error Correction (BEA19 Submission)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial_blocks.html">Tutorial: Blocks/Thano (outdated)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../command_line.html">Command-line reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../predictors.html">Predictors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../decoders.html">Decoders</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../faq.html">Common issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../publications.html">Publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../cam.sgnmt.html">All modules</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../../index.html">SGNMT</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
      
    <li>cam.sgnmt.predictors.length</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for cam.sgnmt.predictors.length</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># coding=utf-8</span>
<span class="c1"># Copyright 2019 The SGNMT Authors.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="sd">&quot;&quot;&quot;This module contains predictors that deal wit the length of the</span>
<span class="sd">target sentence. The ``NBLengthPredictor`` assumes a negative binomial</span>
<span class="sd">distribution on the target sentence lengths, where the parameters r and</span>
<span class="sd">p are linear combinations of features extracted from the source </span>
<span class="sd">sentence. The ``WordCountPredictor`` adds the number of words as cost,</span>
<span class="sd">which can be used to prevent hypotheses from getting to short when </span>
<span class="sd">using a language model.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">scipy.misc</span> <span class="kn">import</span> <span class="n">logsumexp</span>
<span class="kn">from</span> <span class="nn">scipy.special</span> <span class="kn">import</span> <span class="n">gammaln</span>

<span class="kn">from</span> <span class="nn">cam.sgnmt</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">cam.sgnmt.misc.trie</span> <span class="kn">import</span> <span class="n">SimpleTrie</span>
<span class="kn">from</span> <span class="nn">cam.sgnmt.predictors.core</span> <span class="kn">import</span> <span class="n">Predictor</span><span class="p">,</span> <span class="n">UnboundedVocabularyPredictor</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>


<span class="n">NUM_FEATURES</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">EPS_R</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span>



<div class="viewcode-block" id="load_external_lengths"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.load_external_lengths">[docs]</a><span class="k">def</span> <span class="nf">load_external_lengths</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Loads a length distribution from a plain text file. The file</span>
<span class="sd">    must contain blank separated &lt;length&gt;:&lt;score&gt; pairs in each line.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        path (string): Path to the length file.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        list of dicts mapping a length to its scores, one dict for each</span>
<span class="sd">        sentence.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lengths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
                <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">pair</span><span class="p">:</span>
                    <span class="n">length</span><span class="p">,</span> <span class="n">score</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
                    <span class="n">scores</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">length</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">scores</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">pair</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">lengths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lengths</span></div>

<div class="viewcode-block" id="load_external_ids"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.load_external_ids">[docs]</a><span class="k">def</span> <span class="nf">load_external_ids</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    load file of ids to list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
       <span class="k">return</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">]</span></div>

<div class="viewcode-block" id="NBLengthPredictor"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.NBLengthPredictor">[docs]</a><span class="k">class</span> <span class="nc">NBLengthPredictor</span><span class="p">(</span><span class="n">Predictor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This predictor assumes that target sentence lengths are </span>
<span class="sd">    distributed according a negative binomial distribution with </span>
<span class="sd">    parameters r,p. r is linear in features, p is the logistic of a</span>
<span class="sd">    linear function over the features. Weights can be trained using </span>
<span class="sd">    the Matlab script ``estimate_length_model.m`` </span>
<span class="sd">    </span>
<span class="sd">    Let w be the model_weights. All features are extracted from the</span>
<span class="sd">    src sentence::</span>
<span class="sd">    </span>
<span class="sd">      r = w0 * #char</span>
<span class="sd">      + w1 * #words</span>
<span class="sd">      + w2 * #punctuation</span>
<span class="sd">      + w3 * #char/#words</span>
<span class="sd">      + w4 * #punct/#words</span>
<span class="sd">      + w10</span>
<span class="sd">      </span>
<span class="sd">      p = logistic(w5 * #char</span>
<span class="sd">      + w6 * #words</span>
<span class="sd">      + w7 * #punctuation</span>
<span class="sd">      + w8 * #char/#words</span>
<span class="sd">      + w9 * #punct/#words</span>
<span class="sd">      + w11)</span>
<span class="sd">      </span>
<span class="sd">      target_length ~ NB(r,p)</span>
<span class="sd">      </span>
<span class="sd">    The biases w10 and w11 are optional.</span>
<span class="sd">    </span>
<span class="sd">    The predictor predicts EOS with NB(#consumed_words,r,p)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text_file</span><span class="p">,</span> <span class="n">model_weights</span><span class="p">,</span> <span class="n">use_point_probs</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates a new target sentence length model predictor.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            text_file (string): Path to the text file with the </span>
<span class="sd">                                unindexed source sentences, i.e. not</span>
<span class="sd">                                using word ids</span>
<span class="sd">            model_weights (list): Weights w0 to w11 of the length </span>
<span class="sd">                                  model. See class docstring for more</span>
<span class="sd">                                  information</span>
<span class="sd">            use_point_probs (bool): Use point estimates for EOS token,</span>
<span class="sd">                                    0.0 otherwise </span>
<span class="sd">            offset (int): Subtract this from hypothesis length before</span>
<span class="sd">                          applying the NB model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NBLengthPredictor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_point_probs</span> <span class="o">=</span> <span class="n">use_point_probs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_weights</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="o">*</span><span class="n">NUM_FEATURES</span><span class="p">:</span> <span class="c1"># add biases</span>
            <span class="n">model_weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="n">model_weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_weights</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="o">*</span><span class="n">NUM_FEATURES</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span><span class="s2">&quot;Number of length model weights has to be </span><span class="si">%d</span><span class="s2"> or </span><span class="si">%d</span><span class="s2">&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">NUM_FEATURES</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">NUM_FEATURES</span><span class="o">+</span><span class="mi">2</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r_weights</span> <span class="o">=</span> <span class="n">model_weights</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">NUM_FEATURES</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">model_weights</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p_weights</span> <span class="o">=</span> <span class="n">model_weights</span><span class="p">[</span><span class="n">NUM_FEATURES</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">NUM_FEATURES</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">model_weights</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_features</span><span class="p">(</span><span class="n">text_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_consumed</span> <span class="o">=</span> <span class="mi">0</span> 

    <span class="k">def</span> <span class="nf">_extract_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract all features from the source sentences. &quot;&quot;&quot;</span>
        <span class="n">feats</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">feats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_analyse_sentence</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>
        <span class="k">return</span> <span class="n">feats</span>
    
    <span class="k">def</span> <span class="nf">_analyse_sentence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sentence</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract features for a single source sentence.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            sentence (string): Source sentence string</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            5-tuple of features as described in the class docstring</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_char</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sentence</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.0</span>
        <span class="n">n_words</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sentence</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="o">+</span> <span class="mf">0.0</span>
        <span class="n">n_punct</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">sentence</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="s2">&quot;,.:;-&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="mf">0.0</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">n_char</span><span class="p">,</span> <span class="n">n_words</span><span class="p">,</span> <span class="n">n_punct</span><span class="p">,</span> <span class="n">n_char</span><span class="o">/</span><span class="n">n_words</span><span class="p">,</span> <span class="n">n_punct</span><span class="o">/</span><span class="n">n_words</span><span class="p">]</span>
        
<div class="viewcode-block" id="NBLengthPredictor.get_unk_probability"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.NBLengthPredictor.get_unk_probability">[docs]</a>    <span class="k">def</span> <span class="nf">get_unk_probability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">posterior</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;If we use point estimates, return 0 (=1). Otherwise, return</span>
<span class="sd">        the 1-p(EOS), with p(EOS) fetched from ``posterior``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_point_probs</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_consumed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_eos_prob</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_consumed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">posterior</span><span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">EOS_ID</span><span class="p">]))</span></div>
    
<div class="viewcode-block" id="NBLengthPredictor.predict_next"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.NBLengthPredictor.predict_next">[docs]</a>    <span class="k">def</span> <span class="nf">predict_next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a dictionary with single entry for EOS. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_consumed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">utils</span><span class="o">.</span><span class="n">EOS_ID</span> <span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">NEG_INF</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">utils</span><span class="o">.</span><span class="n">EOS_ID</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_eos_prob</span><span class="p">()}</span></div>
    
    <span class="k">def</span> <span class="nf">_get_eos_prob</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get loglikelihood according cur_p, cur_r, and n_consumed &quot;&quot;&quot;</span>
        <span class="n">eos_point_prob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_eos_point_prob</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span>
                                              <span class="mi">1</span><span class="p">,</span> 
                                              <span class="bp">self</span><span class="o">.</span><span class="n">n_consumed</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_point_probs</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">eos_point_prob</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_eos_prob</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_eos_probs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prev_eos_probs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eos_point_prob</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">eos_point_prob</span>
        <span class="c1"># bypass utils.log_sum because we always want to use logsumexp here </span>
        <span class="n">prev_sum</span> <span class="o">=</span> <span class="n">logsumexp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_eos_probs</span><span class="p">]))</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_eos_probs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eos_point_prob</span><span class="p">)</span>
        <span class="c1"># Desired prob is eos_point_prob / (1-last_eos_probs_sum)</span>
        <span class="k">return</span> <span class="n">eos_point_prob</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">prev_sum</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">_get_eos_point_prob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">gammaln</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_r</span><span class="p">)</span> \
                <span class="o">-</span> <span class="n">gammaln</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> \
                <span class="o">-</span> <span class="n">gammaln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cur_r</span><span class="p">)</span> \
                <span class="o">+</span> <span class="n">n</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cur_p</span><span class="p">)</span> \
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_r</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">cur_p</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_get_max_eos_prob</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the maximum loglikelihood according cur_p, cur_r </span>
<span class="sd">        TODO: replace this brute force impl. with something smarter</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">max_prob</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">NEG_INF</span>
        <span class="n">n_prob</span> <span class="o">=</span> <span class="n">max_prob</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">n_prob</span> <span class="o">==</span> <span class="n">max_prob</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">n_prob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_eos_point_prob</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="n">max_prob</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_prob</span><span class="p">,</span> <span class="n">n_prob</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">max_prob</span>
    
<div class="viewcode-block" id="NBLengthPredictor.initialize"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.NBLengthPredictor.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_sentence</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract features for the source sentence. Note that this</span>
<span class="sd">        method does not use ``src_sentence`` as we need the string</span>
<span class="sd">        representation of the source sentence to extract features.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            src_sentence (list): Not used</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">feat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_sen_id</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur_r</span>  <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">EPS_R</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">feat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_weights</span><span class="p">));</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">feat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_weights</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">p</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur_p</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">EPS_P</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">utils</span><span class="o">.</span><span class="n">EPS_P</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_consumed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_eos_probs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_point_probs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_eos_prob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_max_eos_prob</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="NBLengthPredictor.consume"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.NBLengthPredictor.consume">[docs]</a>    <span class="k">def</span> <span class="nf">consume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">word</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Increases the current history length</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            word (int): Not used</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_consumed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_consumed</span> <span class="o">+</span> <span class="mi">1</span></div>
    
<div class="viewcode-block" id="NBLengthPredictor.get_state"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.NBLengthPredictor.get_state">[docs]</a>    <span class="k">def</span> <span class="nf">get_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;State consists of the number of consumed words, and the</span>
<span class="sd">        accumulator for previous EOS probability estimates if we </span>
<span class="sd">        don&#39;t use point estimates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_consumed</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_eos_probs</span></div>
    
<div class="viewcode-block" id="NBLengthPredictor.set_state"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.NBLengthPredictor.set_state">[docs]</a>    <span class="k">def</span> <span class="nf">set_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the predictor state &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_consumed</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_eos_probs</span> <span class="o">=</span> <span class="n">state</span></div>

<div class="viewcode-block" id="NBLengthPredictor.is_equal"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.NBLengthPredictor.is_equal">[docs]</a>    <span class="k">def</span> <span class="nf">is_equal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state1</span><span class="p">,</span> <span class="n">state2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns true if the number of consumed words is the same &quot;&quot;&quot;</span>
        <span class="n">n1</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">state1</span>
        <span class="n">n2</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">state2</span>
        <span class="k">return</span> <span class="n">n1</span> <span class="o">==</span> <span class="n">n2</span></div></div>


<div class="viewcode-block" id="WordCountPredictor"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.WordCountPredictor">[docs]</a><span class="k">class</span> <span class="nc">WordCountPredictor</span><span class="p">(</span><span class="n">Predictor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This predictor adds the (negative) number of words as feature.</span>
<span class="sd">    This means that this predictor encourages shorter hypotheses when</span>
<span class="sd">    used with a positive weight.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">word</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">nonterminal_penalty</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">nonterminal_ids</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">min_terminal_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">max_terminal_id</span><span class="o">=</span><span class="mi">30003</span><span class="p">,</span>
                 <span class="n">negative_wc</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                 <span class="n">vocab_size</span><span class="o">=</span><span class="mi">30003</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates a new word count predictor instance.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            word (int): If this is non-negative we count only the</span>
<span class="sd">                        number of the specified word. If its</span>
<span class="sd">                        negative, count all words</span>
<span class="sd">            nonterminal_penalty (bool): If true, apply penalty only to </span>
<span class="sd">                        tokens in a range  (the range *outside* </span>
<span class="sd">                        min/max terminal id)</span>
<span class="sd">            nonterminal_ids: file containing ids of nonterminal tokens</span>
<span class="sd">            min_terminal_id: lower bound of tokens *not* to penalize,</span>
<span class="sd">                              if nonterminal_penalty selected</span>
<span class="sd">            max_terminal_id: upper bound of tokens *not* to penalize,</span>
<span class="sd">                             if nonterminal_penalty selected</span>
<span class="sd">            negative_wc: If true, the score of this predictor is the </span>
<span class="sd">                         negative word count.</span>
<span class="sd">            vocab_size: upper bound of tokens, used to find nonterminal range</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">WordCountPredictor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="n">val</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">if</span> <span class="n">negative_wc</span><span class="p">:</span>
          <span class="n">val</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="k">if</span> <span class="n">nonterminal_penalty</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">nonterminal_ids</span><span class="p">:</span>
                <span class="n">nts</span> <span class="o">=</span> <span class="n">load_external_ids</span><span class="p">(</span><span class="n">nonterminal_ids</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">min_nt_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">min_terminal_id</span><span class="p">)</span>
                <span class="n">max_nt_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_terminal_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">)</span>
                <span class="n">nts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">min_nt_range</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">max_nt_range</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">posterior</span> <span class="o">=</span> <span class="p">{</span><span class="n">nt</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="n">nt</span> <span class="ow">in</span> <span class="n">nts</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">EOS_ID</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">UNK_ID</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unk_prob</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">elif</span> <span class="n">word</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">posterior</span> <span class="o">=</span> <span class="p">{</span><span class="n">utils</span><span class="o">.</span><span class="n">EOS_ID</span> <span class="p">:</span> <span class="mf">0.0</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unk_prob</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">posterior</span> <span class="o">=</span> <span class="p">{</span><span class="n">word</span> <span class="p">:</span> <span class="n">val</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unk_prob</span> <span class="o">=</span> <span class="mf">0.0</span> 
        
<div class="viewcode-block" id="WordCountPredictor.get_unk_probability"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.WordCountPredictor.get_unk_probability">[docs]</a>    <span class="k">def</span> <span class="nf">get_unk_probability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">posterior</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">unk_prob</span></div>
    
<div class="viewcode-block" id="WordCountPredictor.predict_next"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.WordCountPredictor.predict_next">[docs]</a>    <span class="k">def</span> <span class="nf">predict_next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">posterior</span></div>
    
<div class="viewcode-block" id="WordCountPredictor.initialize"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.WordCountPredictor.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_sentence</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Empty&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>
    
<div class="viewcode-block" id="WordCountPredictor.consume"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.WordCountPredictor.consume">[docs]</a>    <span class="k">def</span> <span class="nf">consume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">word</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Empty&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>
    
<div class="viewcode-block" id="WordCountPredictor.get_state"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.WordCountPredictor.get_state">[docs]</a>    <span class="k">def</span> <span class="nf">get_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns true &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">True</span></div>
    
<div class="viewcode-block" id="WordCountPredictor.set_state"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.WordCountPredictor.set_state">[docs]</a>    <span class="k">def</span> <span class="nf">set_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Empty&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="WordCountPredictor.is_equal"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.WordCountPredictor.is_equal">[docs]</a>    <span class="k">def</span> <span class="nf">is_equal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state1</span><span class="p">,</span> <span class="n">state2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns true &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">True</span></div></div>


<div class="viewcode-block" id="WeightNonTerminalPredictor"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.WeightNonTerminalPredictor">[docs]</a><span class="k">class</span> <span class="nc">WeightNonTerminalPredictor</span><span class="p">(</span><span class="n">Predictor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This wrapper multiplies the weight of given tokens (those outside</span>
<span class="sd">    the min/max terminal range) by a factor.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slave_predictor</span><span class="p">,</span>
                 <span class="n">penalty_factor</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                 <span class="n">nonterminal_ids</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">min_terminal_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">max_terminal_id</span><span class="o">=</span><span class="mi">30003</span><span class="p">,</span>
                 <span class="n">vocab_size</span><span class="o">=</span><span class="mi">30003</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates a new id-weighting wrapper for a predictor</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            slave_predictor: predictor to apply penalty to.</span>
<span class="sd">            penalty_factor (float): factor by which to multiply tokens in range</span>
<span class="sd">            min_terminal_id: lower bound of tokens *not* to penalize, </span>
<span class="sd">        if nonterminal_penalty selected</span>
<span class="sd">            max_terminal_id: upper bound of tokens *not* to penalize,</span>
<span class="sd">        if nonterminal_penalty selected</span>
<span class="sd">            vocab_size: upper bound of tokens, used to find nonterminal range</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">WeightNonTerminalPredictor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">nonterminal_ids</span><span class="p">:</span>
            <span class="n">nts</span> <span class="o">=</span> <span class="n">load_external_ids</span><span class="p">(</span><span class="n">nonterminal_ids</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">min_nt_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">min_terminal_id</span><span class="p">)</span>
            <span class="n">max_nt_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_terminal_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">)</span>
            <span class="n">nts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">min_nt_range</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">max_nt_range</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slave_predictor</span> <span class="o">=</span> <span class="n">slave_predictor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mult</span> <span class="o">=</span> <span class="p">{</span><span class="n">tok</span><span class="p">:</span> <span class="n">penalty_factor</span> <span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="n">nts</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mult</span><span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">EOS_ID</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mult</span><span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">UNK_ID</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        
<div class="viewcode-block" id="WeightNonTerminalPredictor.get_unk_probability"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.WeightNonTerminalPredictor.get_unk_probability">[docs]</a>    <span class="k">def</span> <span class="nf">get_unk_probability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">posterior</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">slave_predictor</span><span class="o">.</span><span class="n">get_unk_probability</span><span class="p">(</span><span class="n">posterior</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="WeightNonTerminalPredictor.predict_next"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.WeightNonTerminalPredictor.predict_next">[docs]</a>    <span class="k">def</span> <span class="nf">predict_next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">posterior</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slave_predictor</span><span class="o">.</span><span class="n">predict_next</span><span class="p">()</span>
        <span class="n">post_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">common_viewkeys</span><span class="p">(</span><span class="n">posterior</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mult</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tok</span> <span class="ow">in</span> <span class="n">post_keys</span><span class="p">:</span>
                <span class="n">posterior</span><span class="p">[</span><span class="n">tok</span><span class="p">]</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mult</span><span class="p">[</span><span class="n">tok</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">posterior</span></div>
    
<div class="viewcode-block" id="WeightNonTerminalPredictor.initialize"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.WeightNonTerminalPredictor.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_sentence</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slave_predictor</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">src_sentence</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="WeightNonTerminalPredictor.consume"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.WeightNonTerminalPredictor.consume">[docs]</a>    <span class="k">def</span> <span class="nf">consume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">word</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">slave_predictor</span><span class="o">.</span><span class="n">consume</span><span class="p">(</span><span class="n">word</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="WeightNonTerminalPredictor.get_state"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.WeightNonTerminalPredictor.get_state">[docs]</a>    <span class="k">def</span> <span class="nf">get_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">slave_predictor</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="WeightNonTerminalPredictor.set_state"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.WeightNonTerminalPredictor.set_state">[docs]</a>    <span class="k">def</span> <span class="nf">set_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slave_predictor</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="WeightNonTerminalPredictor.is_equal"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.WeightNonTerminalPredictor.is_equal">[docs]</a>    <span class="k">def</span> <span class="nf">is_equal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state1</span><span class="p">,</span> <span class="n">state2</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">slave_predictor</span><span class="o">.</span><span class="n">is_equal</span><span class="p">(</span><span class="n">state1</span><span class="p">,</span> <span class="n">state2</span><span class="p">)</span></div></div>



<div class="viewcode-block" id="ExternalLengthPredictor"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.ExternalLengthPredictor">[docs]</a><span class="k">class</span> <span class="nc">ExternalLengthPredictor</span><span class="p">(</span><span class="n">Predictor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This predictor loads the distribution over target sentence</span>
<span class="sd">    lengths from an external file. The file contains blank separated</span>
<span class="sd">    length:score pairs in each line which define the length </span>
<span class="sd">    distribution. The predictor adds the specified scores directly</span>
<span class="sd">    to the EOS score.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates a external length distribution predictor.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            path (string): Path to the file with target sentence length</span>
<span class="sd">                           distributions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ExternalLengthPredictor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trg_lengths</span> <span class="o">=</span> <span class="n">load_external_lengths</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        
<div class="viewcode-block" id="ExternalLengthPredictor.get_unk_probability"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.ExternalLengthPredictor.get_unk_probability">[docs]</a>    <span class="k">def</span> <span class="nf">get_unk_probability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">posterior</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns 0=log 1 if the partial hypothesis does not exceed</span>
<span class="sd">        max length. Otherwise, predict next returns an empty set,</span>
<span class="sd">        and we set everything else to -inf.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_consumed</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">NEG_INF</span></div>
    
<div class="viewcode-block" id="ExternalLengthPredictor.predict_next"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.ExternalLengthPredictor.predict_next">[docs]</a>    <span class="k">def</span> <span class="nf">predict_next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a dictionary with one entry and value 0 (=log 1). The</span>
<span class="sd">        key is either the next word in the target sentence or (if the</span>
<span class="sd">        target sentence has no more words) the end-of-sentence symbol.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_consumed</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_scores</span><span class="p">:</span> 
            <span class="k">return</span> <span class="p">{</span><span class="n">utils</span><span class="o">.</span><span class="n">EOS_ID</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_scores</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">n_consumed</span><span class="p">]}</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">utils</span><span class="o">.</span><span class="n">EOS_ID</span> <span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">NEG_INF</span><span class="p">}</span> </div>
    
<div class="viewcode-block" id="ExternalLengthPredictor.initialize"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.ExternalLengthPredictor.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_sentence</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fetches the corresponding target sentence length </span>
<span class="sd">        distribution and resets the word counter.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            src_sentence (list):  Not used</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trg_lengths</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_sen_id</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cur_scores</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_consumed</span> <span class="o">=</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="ExternalLengthPredictor.consume"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.ExternalLengthPredictor.consume">[docs]</a>    <span class="k">def</span> <span class="nf">consume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">word</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Increases word counter by one.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            word (int): Not used</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_consumed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_consumed</span> <span class="o">+</span> <span class="mi">1</span></div>
    
<div class="viewcode-block" id="ExternalLengthPredictor.get_state"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.ExternalLengthPredictor.get_state">[docs]</a>    <span class="k">def</span> <span class="nf">get_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the number of consumed words &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_consumed</span></div>
    
<div class="viewcode-block" id="ExternalLengthPredictor.set_state"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.ExternalLengthPredictor.set_state">[docs]</a>    <span class="k">def</span> <span class="nf">set_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the number of consumed words &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_consumed</span> <span class="o">=</span> <span class="n">state</span></div>

<div class="viewcode-block" id="ExternalLengthPredictor.is_equal"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.ExternalLengthPredictor.is_equal">[docs]</a>    <span class="k">def</span> <span class="nf">is_equal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state1</span><span class="p">,</span> <span class="n">state2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns true if the number of consumed words is the same &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">state1</span> <span class="o">==</span> <span class="n">state2</span></div></div>


<div class="viewcode-block" id="NgramCountPredictor"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.NgramCountPredictor">[docs]</a><span class="k">class</span> <span class="nc">NgramCountPredictor</span><span class="p">(</span><span class="n">Predictor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This predictor counts the number of n-grams in hypotheses. n-gram</span>
<span class="sd">    posteriors are loaded from a file. The predictor score is the sum of</span>
<span class="sd">    all n-gram posteriors in a hypothesis. &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">discount_factor</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates a new ngram count predictor instance.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            path (string): Path to the n-gram posteriors. File format:</span>
<span class="sd">                           &lt;ngram&gt; : &lt;score&gt; (one ngram per line). Use</span>
<span class="sd">                           placeholder %d for sentence id.</span>
<span class="sd">            order (int): If positive, count n-grams of the specified</span>
<span class="sd">                         order. Otherwise, count all n-grams</span>
<span class="sd">            discount_factor (float): If non-negative, discount n-gram</span>
<span class="sd">                                     posteriors by this factor each time </span>
<span class="sd">                                     they are consumed </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NgramCountPredictor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="n">order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discount_factor</span> <span class="o">=</span> <span class="n">discount_factor</span>
        
<div class="viewcode-block" id="NgramCountPredictor.get_unk_probability"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.NgramCountPredictor.get_unk_probability">[docs]</a>    <span class="k">def</span> <span class="nf">get_unk_probability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">posterior</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Always return 0.0 &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mf">0.0</span></div>
    
<div class="viewcode-block" id="NgramCountPredictor.predict_next"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.NgramCountPredictor.predict_next">[docs]</a>    <span class="k">def</span> <span class="nf">predict_next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Composes the posterior vector by collecting all ngrams which</span>
<span class="sd">        are consistent with the current history.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">posterior</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cur_history</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)):</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngrams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cur_history</span><span class="p">[</span><span class="n">i</span><span class="p">:])</span>
            <span class="k">if</span> <span class="n">scores</span><span class="p">:</span>
                <span class="n">factors</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">discount_factor</span> <span class="o">&gt;=</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">factors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">discounts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cur_history</span><span class="p">[</span><span class="n">i</span><span class="p">:])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">factors</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">w</span><span class="p">,</span><span class="n">score</span> <span class="ow">in</span> <span class="n">scores</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">posterior</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="o">=</span> <span class="n">posterior</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">+</span> <span class="n">score</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">w</span><span class="p">,</span><span class="n">score</span> <span class="ow">in</span> <span class="n">scores</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">posterior</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="o">=</span> <span class="n">posterior</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">+</span>  \
                                       <span class="n">factors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">score</span>
        <span class="k">return</span> <span class="n">posterior</span></div>
    
    <span class="k">def</span> <span class="nf">_load_posteriors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets up self.max_history_len and self.ngrams &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_history_len</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ngrams</span> <span class="o">=</span> <span class="n">SimpleTrie</span><span class="p">()</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loading n-gram scores from </span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">ngram</span><span class="p">,</span><span class="n">score</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
                <span class="n">words</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">ngram</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">hist</span> <span class="o">=</span> <span class="n">words</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">last_word</span> <span class="o">=</span> <span class="n">words</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">last_word</span> <span class="o">==</span> <span class="n">utils</span><span class="o">.</span><span class="n">GO_ID</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">max_history_len</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_history_len</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">hist</span><span class="p">))</span>
                <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngrams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">p</span><span class="p">:</span>
                    <span class="n">p</span><span class="p">[</span><span class="n">last_word</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">score</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ngrams</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">hist</span><span class="p">,</span> <span class="p">{</span><span class="n">last_word</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">score</span><span class="o">.</span><span class="n">strip</span><span class="p">())})</span>
    
<div class="viewcode-block" id="NgramCountPredictor.initialize"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.NgramCountPredictor.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_sentence</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Loads n-gram posteriors and resets history.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            src_sentence (list): not used</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_posteriors</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_sen_id</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur_history</span> <span class="o">=</span> <span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">GO_ID</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discounts</span> <span class="o">=</span> <span class="n">SimpleTrie</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="NgramCountPredictor.consume"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.NgramCountPredictor.consume">[docs]</a>    <span class="k">def</span> <span class="nf">consume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">word</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds ``word`` to the current history. Shorten if the extended</span>
<span class="sd">        history exceeds ``max_history_len``.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            word (int): Word to add to the history.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cur_history</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_history_len</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cur_history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_history</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">max_history_len</span><span class="p">:]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">discount_factor</span> <span class="o">&gt;=</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cur_history</span><span class="p">)):</span>
                <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_history</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">factors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">discounts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">factors</span><span class="p">:</span>
                    <span class="n">factors</span> <span class="o">=</span> <span class="p">{</span><span class="n">word</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">discount_factor</span><span class="p">}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">factors</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="n">factors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">discount_factor</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">discounts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">factors</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="NgramCountPredictor.get_state"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.NgramCountPredictor.get_state">[docs]</a>    <span class="k">def</span> <span class="nf">get_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Current history is the predictor state &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_history</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">discounts</span></div>
    
<div class="viewcode-block" id="NgramCountPredictor.set_state"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.NgramCountPredictor.set_state">[docs]</a>    <span class="k">def</span> <span class="nf">set_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Current history is the predictor state &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur_history</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">discounts</span> <span class="o">=</span> <span class="n">state</span></div>

<div class="viewcode-block" id="NgramCountPredictor.is_equal"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.NgramCountPredictor.is_equal">[docs]</a>    <span class="k">def</span> <span class="nf">is_equal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state1</span><span class="p">,</span> <span class="n">state2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Hypothesis recombination is</span>
<span class="sd">        not supported if discounting is enabled.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">discount_factor</span> <span class="o">&gt;=</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="n">hist1</span> <span class="o">=</span> <span class="n">state1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">hist2</span> <span class="o">=</span> <span class="n">state2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">hist1</span> <span class="o">==</span> <span class="n">hist2</span><span class="p">:</span> <span class="c1"># Return true if histories match</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hist1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">hist2</span><span class="p">):</span>
            <span class="n">hist_long</span> <span class="o">=</span> <span class="n">hist1</span>
            <span class="n">hist_short</span> <span class="o">=</span> <span class="n">hist2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hist_long</span> <span class="o">=</span> <span class="n">hist2</span>
            <span class="n">hist_short</span> <span class="o">=</span> <span class="n">hist1</span>
        <span class="n">min_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">hist_short</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">min_len</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span> <span class="c1"># Look up non matching in self.ngrams</span>
            <span class="n">key1</span> <span class="o">=</span> <span class="n">hist1</span><span class="p">[</span><span class="o">-</span><span class="n">n</span><span class="p">:]</span>
            <span class="n">key2</span> <span class="o">=</span> <span class="n">hist2</span><span class="p">[</span><span class="o">-</span><span class="n">n</span><span class="p">:]</span>
            <span class="k">if</span> <span class="n">key1</span> <span class="o">!=</span> <span class="n">key2</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngrams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key1</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngrams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key2</span><span class="p">):</span>
                    <span class="k">return</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">min_len</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">hist_long</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngrams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">hist_long</span><span class="p">[</span><span class="o">-</span><span class="n">n</span><span class="p">:]):</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span></div></div>


<div class="viewcode-block" id="UnkCountPredictor"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.UnkCountPredictor">[docs]</a><span class="k">class</span> <span class="nc">UnkCountPredictor</span><span class="p">(</span><span class="n">Predictor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This predictor regulates the number of UNKs in the output. We </span>
<span class="sd">    assume that the number of UNKs in the target sentence is Poisson </span>
<span class="sd">    distributed. This predictor is configured with n lambdas for</span>
<span class="sd">    0,1,...,&gt;=n-1 UNKs in the source sentence. &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_vocab_size</span><span class="p">,</span> <span class="n">lambdas</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes the UNK count predictor.</span>

<span class="sd">        Args:</span>
<span class="sd">            src_vocab_size (int): Size of source language vocabulary.</span>
<span class="sd">                                  Indices greater than this are </span>
<span class="sd">                                  considered as UNK.</span>
<span class="sd">            lambdas (list): List of floats. The first entry is the </span>
<span class="sd">                            lambda parameter given that the number of</span>
<span class="sd">                            unks in the source sentence is 0 etc. The</span>
<span class="sd">                            last float is lambda given that the source</span>
<span class="sd">                            sentence has more than n-1 unks.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span> <span class="o">=</span> <span class="n">lambdas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="n">lambdas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src_vocab_size</span> <span class="o">=</span> <span class="n">src_vocab_size</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">UnkCountPredictor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        
<div class="viewcode-block" id="UnkCountPredictor.get_unk_probability"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.UnkCountPredictor.get_unk_probability">[docs]</a>    <span class="k">def</span> <span class="nf">get_unk_probability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">posterior</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Always returns 0 (= log 1) except for the first time &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_consumed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_prob</span>
        <span class="k">return</span> <span class="mf">0.0</span></div>
    
<div class="viewcode-block" id="UnkCountPredictor.predict_next"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.UnkCountPredictor.predict_next">[docs]</a>    <span class="k">def</span> <span class="nf">predict_next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set score for EOS to the number of consumed words &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_consumed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">utils</span><span class="o">.</span><span class="n">EOS_ID</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">unk_prob</span><span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_unk</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_prob_idx</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">utils</span><span class="o">.</span><span class="n">EOS_ID</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">unk_prob</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_prob</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">utils</span><span class="o">.</span><span class="n">UNK_ID</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">unk_prob</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">consumed_prob</span><span class="p">}</span></div>
    
<div class="viewcode-block" id="UnkCountPredictor.initialize"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.UnkCountPredictor.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_sentence</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Count UNKs in ``src_sentence`` and reset counters.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            src_sentence (list): Count UNKs in this list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">src_n_unk</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">w</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">src_sentence</span> <span class="k">if</span> <span class="n">w</span> <span class="o">==</span> <span class="n">utils</span><span class="o">.</span><span class="n">UNK_ID</span> 
                                                    <span class="ow">or</span> <span class="n">w</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_vocab_size</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">src_n_unk</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_consumed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_unk</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unk_prob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_poisson_prob</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Mode at lambda is the maximum of the poisson function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_prob_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_prob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_poisson_prob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_prob_idx</span><span class="p">)</span>
        <span class="n">ceil_prob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_poisson_prob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_prob_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ceil_prob</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_prob</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_prob</span> <span class="o">=</span> <span class="n">ceil_prob</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_prob_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_prob_idx</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">consumed_prob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_prob</span></div>

    <span class="k">def</span> <span class="nf">_get_poisson_prob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the log of the poisson probability for n events. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">n</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)])</span>
    
<div class="viewcode-block" id="UnkCountPredictor.consume"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.UnkCountPredictor.consume">[docs]</a>    <span class="k">def</span> <span class="nf">consume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">word</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Increases unk counter by one if ``word`` is unk.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            word (int): Increase counter if ``word`` is UNK</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_consumed</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">word</span> <span class="o">==</span> <span class="n">utils</span><span class="o">.</span><span class="n">UNK_ID</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_unk</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_prob_idx</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">consumed_prob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unk_prob</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_unk</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unk_prob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_poisson_prob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_unk</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="UnkCountPredictor.get_state"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.UnkCountPredictor.get_state">[docs]</a>    <span class="k">def</span> <span class="nf">get_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the number of consumed words &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_unk</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">n_consumed</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">unk_prob</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">consumed_prob</span></div>
    
<div class="viewcode-block" id="UnkCountPredictor.set_state"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.UnkCountPredictor.set_state">[docs]</a>    <span class="k">def</span> <span class="nf">set_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the number of consumed words &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_unk</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">n_consumed</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">unk_prob</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">consumed_prob</span> <span class="o">=</span> <span class="n">state</span></div>

<div class="viewcode-block" id="UnkCountPredictor.is_equal"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.UnkCountPredictor.is_equal">[docs]</a>    <span class="k">def</span> <span class="nf">is_equal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state1</span><span class="p">,</span> <span class="n">state2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns true if the state is the same&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">state1</span> <span class="o">==</span> <span class="n">state2</span></div></div>

    
<div class="viewcode-block" id="NgramizePredictor"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.NgramizePredictor">[docs]</a><span class="k">class</span> <span class="nc">NgramizePredictor</span><span class="p">(</span><span class="n">Predictor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This wrapper extracts n-gram posteriors from a predictor which</span>
<span class="sd">    does not depend on the particular argument of `consume()`. In that</span>
<span class="sd">    case, we can build a lookup mechanism for all possible n-grams in</span>
<span class="sd">    a single forward pass through the predictor search space: We record</span>
<span class="sd">    all posteriors (predict_next() return values) of the slave</span>
<span class="sd">    predictor during a greedy pass in `initialize()`. The wrapper</span>
<span class="sd">    predictor state is the current n-gram history. We use the </span>
<span class="sd">    (semiring) sum over all possible positions of the current n-gram</span>
<span class="sd">    history in the recorded slave predictor posteriors to form the</span>
<span class="sd">    n-gram scores returned by this predictor.</span>

<span class="sd">    Note that this wrapper does not work correctly if the slave</span>
<span class="sd">    predictor feeds back the selected token in the history, ie. depends</span>
<span class="sd">    on the particular token which is provided via `consume()`.</span>

<span class="sd">    TODO: Make this wrapper work with slaves which return dicts.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_order</span><span class="p">,</span> <span class="n">max_order</span><span class="p">,</span> <span class="n">max_len_factor</span><span class="p">,</span> <span class="n">slave_predictor</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates a new ngramize wrapper predictor.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            min_order (int): Minimum n-gram order</span>
<span class="sd">            max_order (int): Maximum n-gram order</span>
<span class="sd">            max_len_factor (int): Stop the forward pass through the </span>
<span class="sd">                                  slave predictor after src_length</span>
<span class="sd">                                  times this factor</span>
<span class="sd">            slave_predictor (Predictor): Instance of the predictor which</span>
<span class="sd">                                         uses the source sentences in</span>
<span class="sd">                                         ``src_test``</span>

<span class="sd">        Raises:</span>
<span class="sd">            AttributeError if order is not positive.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NgramizePredictor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">max_order</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
             <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;max_ngram_order must be positive.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">min_order</span> <span class="o">&gt;</span> <span class="n">max_order</span><span class="p">:</span>
             <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;min_ngram_order greater than max_order.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slave_predictor</span> <span class="o">=</span> <span class="n">slave_predictor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_history_length</span> <span class="o">=</span> <span class="n">max_order</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_order</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">min_order</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_len_factor</span> <span class="o">=</span> <span class="n">max_len_factor</span>
    
<div class="viewcode-block" id="NgramizePredictor.initialize"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.NgramizePredictor.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_sentence</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Runs greedy decoding on the slave predictor to populate</span>
<span class="sd">        self.scores and self.unk_scores, resets the history.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slave_predictor</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">src_sentence</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unk_scores</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">trg_word</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">max_len</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_len_factor</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">src_sentence</span><span class="p">)</span>
        <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">trg_word</span> <span class="o">!=</span> <span class="n">utils</span><span class="o">.</span><span class="n">EOS_ID</span> <span class="ow">and</span> <span class="n">l</span> <span class="o">&lt;=</span> <span class="n">max_len</span><span class="p">:</span>
            <span class="n">posterior</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slave_predictor</span><span class="o">.</span><span class="n">predict_next</span><span class="p">()</span>
            <span class="n">trg_word</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">posterior</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">posterior</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unk_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slave_predictor</span><span class="o">.</span><span class="n">get_unk_probability</span><span class="p">(</span>
                <span class="n">posterior</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slave_predictor</span><span class="o">.</span><span class="n">consume</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">UNK_ID</span><span class="p">)</span>
            <span class="n">l</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;ngramize uses </span><span class="si">%d</span><span class="s2"> time steps.&quot;</span> <span class="o">%</span> <span class="n">l</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur_unk_score</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">NEG_INF</span></div>
    
<div class="viewcode-block" id="NgramizePredictor.initialize_heuristic"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.NgramizePredictor.initialize_heuristic">[docs]</a>    <span class="k">def</span> <span class="nf">initialize_heuristic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_sentence</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pass through to slave predictor &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;ngramize does not support predictor heuristics&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slave_predictor</span><span class="o">.</span><span class="n">initialize_heuristic</span><span class="p">(</span><span class="n">src_sentence</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="NgramizePredictor.predict_next"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.NgramizePredictor.predict_next">[docs]</a>    <span class="k">def</span> <span class="nf">predict_next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Looks up ngram scores via self.scores. &quot;&quot;&quot;</span>
        <span class="n">cur_hist_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">)</span>
        <span class="n">this_scores</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cur_hist_length</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
        <span class="n">this_unk_scores</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cur_hist_length</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">)):</span>
            <span class="n">this_scores</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span>
            <span class="n">this_unk_scores</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unk_scores</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span>
            <span class="n">acc</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">for</span> <span class="n">order</span><span class="p">,</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">order</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">):</span>
                    <span class="k">break</span>
                <span class="n">acc</span> <span class="o">+=</span> <span class="n">utils</span><span class="o">.</span><span class="n">common_get</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">[</span><span class="n">pos</span> <span class="o">+</span> <span class="n">order</span><span class="p">],</span> <span class="n">word</span><span class="p">,</span> 
                    <span class="bp">self</span><span class="o">.</span><span class="n">unk_scores</span><span class="p">[</span><span class="n">pos</span> <span class="o">+</span> <span class="n">order</span><span class="p">])</span>
                <span class="n">this_scores</span><span class="p">[</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">acc</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">[</span><span class="n">pos</span> <span class="o">+</span> <span class="n">order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">this_unk_scores</span><span class="p">[</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">acc</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">unk_scores</span><span class="p">[</span><span class="n">pos</span> <span class="o">+</span> <span class="n">order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">combined_scores</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">combined_unk_scores</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">order</span><span class="p">,</span> <span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">unk_scores</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">this_scores</span><span class="p">,</span> 
                                                         <span class="n">this_unk_scores</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">scores</span> <span class="ow">and</span> <span class="n">order</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_order</span><span class="p">:</span>
                <span class="n">score_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
                <span class="n">combined_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">logsumexp</span><span class="p">(</span><span class="n">score_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
                <span class="n">combined_unk_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">log_sum</span><span class="p">(</span><span class="n">unk_scores</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">combined_scores</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cur_unk_score</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur_unk_score</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">combined_unk_scores</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">combined_scores</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="NgramizePredictor.get_unk_probability"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.NgramizePredictor.get_unk_probability">[docs]</a>    <span class="k">def</span> <span class="nf">get_unk_probability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">posterior</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_unk_score</span></div>
    
<div class="viewcode-block" id="NgramizePredictor.consume"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.NgramizePredictor.consume">[docs]</a>    <span class="k">def</span> <span class="nf">consume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">word</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pass through to slave predictor &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_history_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">max_history_length</span><span class="p">:]</span></div>
    
<div class="viewcode-block" id="NgramizePredictor.get_state"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.NgramizePredictor.get_state">[docs]</a>    <span class="k">def</span> <span class="nf">get_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;State is the current n-gram history. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_unk_score</span></div>
    
<div class="viewcode-block" id="NgramizePredictor.set_state"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.NgramizePredictor.set_state">[docs]</a>    <span class="k">def</span> <span class="nf">set_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;State is the current n-gram history. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_unk_score</span> <span class="o">=</span> <span class="n">state</span></div>

<div class="viewcode-block" id="NgramizePredictor.set_current_sen_id"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.NgramizePredictor.set_current_sen_id">[docs]</a>    <span class="k">def</span> <span class="nf">set_current_sen_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cur_sen_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;We need to override this method to propagate current\_</span>
<span class="sd">        sentence_id to the slave predictor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NgramizePredictor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">set_current_sen_id</span><span class="p">(</span><span class="n">cur_sen_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slave_predictor</span><span class="o">.</span><span class="n">set_current_sen_id</span><span class="p">(</span><span class="n">cur_sen_id</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="NgramizePredictor.is_equal"><a class="viewcode-back" href="../../../../predictors.html#cam.sgnmt.predictors.length.NgramizePredictor.is_equal">[docs]</a>    <span class="k">def</span> <span class="nf">is_equal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state1</span><span class="p">,</span> <span class="n">state2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pass through to slave predictor &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">state1</span> <span class="o">==</span> <span class="n">state2</span></div></div>
        

</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, University of Cambridge.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../../',
            VERSION:'1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>